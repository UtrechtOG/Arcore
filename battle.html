<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Battle</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background-color: #1e1e2f;
  color: white;
}

#battlefield {
  display: flex;
  justify-content: space-between;
  padding: 40px;
}

.card {
  width: 160px;
  height: 200px;
  border: 3px solid #4caf50;
  border-radius: 12px;
  background-color: #2a2a3f;
  padding: 10px;
}

.enemy {
  border-color: red;
}

.hp {
  margin-top: 8px;
  font-size: 14px;
}

#actions {
  position: fixed;
  bottom: 0;
  width: 100%;
  background-color: #2a2a3f;
  display: flex;
  justify-content: space-around;
  padding: 15px;
}

.action {
  width: 90px;
  height: 60px;
  border: 2px solid #4caf50;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  font-size: 12px;
}

.action:hover {
  background-color: #35354f;
}

#timer {
  position: fixed;
  top: 10px;
  right: 20px;
  font-size: 18px;
}
</style>
</head>

<body>

<div id="timer">30</div>

<div id="battlefield">
  <div id="enemyCard" class="card enemy"></div>
  <div id="playerCard" class="card"></div>
</div>

<div id="actions"></div>

<script src="cards.js"></script>
<script>
/* ---------- SETUP ---------- */
let score = parseInt(localStorage.getItem("score")) || 0;

function clone(card) {
  return JSON.parse(JSON.stringify(card));
}

function randomDeck() {
  const shuffled = [...cards].sort(() => 0.5 - Math.random());
  return [clone(shuffled[0]), clone(shuffled[1])];
}

let playerDeck = randomDeck();
let enemyDeck = randomDeck();

let player = playerDeck.shift();
let enemy = enemyDeck.shift();

player.currentHp = player.hp;
enemy.currentHp = enemy.hp;

let playerStatus = {};
let enemyStatus = {};

let playerTurn = true;
let timer = 30;

/* ---------- RENDER ---------- */
const playerDiv = document.getElementById("playerCard");
const enemyDiv = document.getElementById("enemyCard");
const actionsDiv = document.getElementById("actions");
const timerDiv = document.getElementById("timer");

function render() {
  playerDiv.innerHTML = `
    <b>${player.name}</b>
    <div class="hp">HP: ${player.currentHp} / ${player.hp}</div>
  `;
  enemyDiv.innerHTML = `
    <b>${enemy.name}</b>
    <div class="hp">HP: ${enemy.currentHp} / ${enemy.hp}</div>
  `;

  actionsDiv.innerHTML = "";
  player.attacks.forEach(a => {
    const btn = document.createElement("div");
    btn.className = "action";
    btn.innerText = a.name;
    btn.onclick = () => playerTurn && useAttack(a);
    actionsDiv.appendChild(btn);
  });
}

render();

/* ---------- TIMER ---------- */
setInterval(() => {
  if (!playerTurn) return;
  timer--;
  timerDiv.innerText = timer;
  if (timer <= 0) {
    useAttack(player.attacks[Math.floor(Math.random() * 4)]);
  }
}, 1000);

function resetTimer() {
  timer = 30;
  timerDiv.innerText = timer;
}

/* ---------- ATTACK LOGIC ---------- */
function useAttack(attack) {
  resetTimer();
  applyAttack(player, enemy, attack, enemyStatus);
  endTurn();
}

function applyAttack(attacker, target, attack, targetStatus) {
  switch (attack.type) {
    case "damage":
      target.currentHp -= attack.value;
      break;

    case "damageChance":
      target.currentHp -= Math.random() < attack.chance ? attack.crit : attack.value;
      break;

    case "heal":
      attacker.currentHp = Math.min(attacker.hp, attacker.currentHp + attack.value);
      break;

    case "freeze":
      targetStatus.freeze = attack.value;
      break;

    case "dot":
      targetStatus.dot = attack.duration;
      break;
  }
}

/* ---------- TURN FLOW ---------- */
function endTurn() {
  if (enemy.currentHp <= 0) nextEnemy();
  playerTurn = false;
  setTimeout(enemyTurn, 800);
  render();
}

function enemyTurn() {
  if (enemyStatus.freeze > 0) {
    enemyStatus.freeze--;
    playerTurn = true;
    return;
  }

  const atk = enemy.attacks[Math.floor(Math.random() * 4)];
  applyAttack(enemy, player, atk, playerStatus);

  if (player.currentHp <= 0) nextPlayer();

  playerTurn = true;
  render();
}

/* ---------- NEXT CARDS ---------- */
function nextEnemy() {
  if (enemyDeck.length === 0) return win();
  enemy = enemyDeck.shift();
  enemy.currentHp = enemy.hp;
  enemyStatus = {};
}

function nextPlayer() {
  if (playerDeck.length === 0) return lose();
  player = playerDeck.shift();
  player.currentHp = player.hp;
  playerStatus = {};
}

/* ---------- END GAME ---------- */
function win() {
  const gain = Math.floor(Math.random() * 5) + 3;
  localStorage.setItem("score", score + gain);
  alert(`Sieg! +${gain} Punkte`);
  window.location = "index.html";
}

function lose() {
  const loss = Math.floor(Math.random() * 10) + 5;
  score = Math.max(0, score - loss);
  localStorage.setItem("score", score);
  alert(`Niederlage! -${loss} Punkte`);
  window.location = "index.html";
}
</script>

</body>
</html>
